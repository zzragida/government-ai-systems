<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGCT ì§€ê°‘ ë“±ë¡ | AI City Inc.</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .step {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #2563eb;
        }
        .step-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
        }
        .step-title {
            font-size: 20px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .info-box {
            background: white;
            border: 2px solid #2563eb;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #64748b;
        }
        .info-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 18px;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .warning-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .warning ul {
            margin-left: 20px;
            color: #856404;
        }
        .warning li {
            margin: 8px 0;
        }
        .mnemonic-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .mnemonic-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .mnemonic-words {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .mnemonic-word {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }
        .mnemonic-word-number {
            display: block;
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }
        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            padding: 20px;
            border-radius: 10px;
            color: #065f46;
            text-align: center;
        }
        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 10px;
            color: #991b1b;
            text-align: center;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .checkbox-group {
            margin: 20px 0;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        #downloadSection {
            background: #f0f9ff;
            border: 2px solid #2563eb;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .download-btn {
            background: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .download-btn:hover {
            background: #059669;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” EGCT ì§€ê°‘ ë“±ë¡</h1>
            <p>AI City Inc. ë””ì§€í„¸ í™”í ë³´ìœ ì ì§€ê°‘ ìƒì„±</p>
        </div>

        <div class="content">
            <!-- Loading -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 20px; color: #64748b;">í† í° ê²€ì¦ ì¤‘...</p>
            </div>

            <!-- Error -->
            <div id="errorSection" class="hidden error">
                <h3>âŒ ì˜¤ë¥˜</h3>
                <p id="errorMessage"></p>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="hidden">
                <!-- Step 1: ë³¸ì¸ ì •ë³´ í™•ì¸ -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">1</span>
                        ë³¸ì¸ ì •ë³´ í™•ì¸
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">ì„±ëª…</span>
                            <span class="info-value" id="holderName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì´ë©”ì¼</span>
                            <span class="info-value" id="holderEmail">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">EGCT í• ë‹¹ëŸ‰</span>
                            <span class="info-value" id="holderAllocation" style="color: #2563eb;">-</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: ë³´ì•ˆ ê²½ê³  -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">2</span>
                        ë³´ì•ˆ ì£¼ì˜ì‚¬í•­
                    </div>
                    <div class="warning">
                        <div class="warning-title">âš ï¸ ë°˜ë“œì‹œ ì½ì–´ì£¼ì„¸ìš”!</div>
                        <ul>
                            <li><strong>12ê°œ ë‹¨ì–´</strong>ë¥¼ ë°˜ë“œì‹œ ì¢…ì´ì— ì ì–´ì„œ ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì„¸ìš”</li>
                            <li>ë‹¨ì–´ë¥¼ <strong>ë¶„ì‹¤í•˜ë©´ ìì‚°ì„ ì˜êµ¬ì ìœ¼ë¡œ ìƒìŠµë‹ˆë‹¤</strong></li>
                            <li>ë‹¨ì–´ë¥¼ <strong>íƒ€ì¸ì—ê²Œ ì ˆëŒ€ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”</strong></li>
                            <li>ìŠ¤í¬ë¦°ìƒ·, ì‚¬ì§„ ì´¬ì˜, í´ë¼ìš°ë“œ ì €ì¥ì€ ìœ„í—˜í•©ë‹ˆë‹¤</li>
                            <li>Private KeyëŠ” ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šìœ¼ë©°, ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ìƒì„±ë©ë‹ˆë‹¤</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 3: ì§€ê°‘ ìƒì„± -->
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">3</span>
                        ì§€ê°‘ ìƒì„±
                    </div>
                    <button onclick="generateWallet()" id="generateBtn">
                        ğŸ”‘ ì§€ê°‘ ìƒì„±í•˜ê¸°
                    </button>
                </div>

                <!-- Step 4: ë‹ˆëª¨ë‹‰ í‘œì‹œ (ìƒì„± í›„) -->
                <div id="mnemonicSection" class="step hidden">
                    <div class="step-title">
                        <span class="step-number">4</span>
                        ë³µêµ¬ ë‹¨ì–´ (Mnemonic)
                    </div>
                    <div class="mnemonic-box">
                        <div class="mnemonic-title">ğŸ“ ì´ 12ê°œ ë‹¨ì–´ë¥¼ ì¢…ì´ì— ì ìœ¼ì„¸ìš”</div>
                        <div class="mnemonic-words" id="mnemonicWords"></div>
                    </div>
                    <div class="warning">
                        <p><strong>âš ï¸ ì£¼ì˜:</strong> ì´ ë‹¨ì–´ë“¤ì€ ë‹¤ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì¢…ì´ì— ì ì–´ì£¼ì„¸ìš”!</p>
                    </div>
                </div>

                <!-- Step 5: í™•ì¸ ì²´í¬ë°•ìŠ¤ -->
                <div id="confirmSection" class="step hidden">
                    <div class="step-title">
                        <span class="step-number">5</span>
                        í™•ì¸ ì‚¬í•­
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="check1" onchange="checkAllConfirmed()">
                            <span>12ê°œ ë‹¨ì–´ë¥¼ ì¢…ì´ì— ì ì–´ì„œ ì•ˆì „í•œ ê³³ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤</span>
                        </label>
                        <label>
                            <input type="checkbox" id="check2" onchange="checkAllConfirmed()">
                            <span>ë‹¨ì–´ë¥¼ ë¶„ì‹¤í•˜ë©´ ìì‚°ì„ ì˜êµ¬ì ìœ¼ë¡œ ìƒëŠ”ë‹¤ëŠ” ê²ƒì„ ì´í•´í–ˆìŠµë‹ˆë‹¤</span>
                        </label>
                        <label>
                            <input type="checkbox" id="check3" onchange="checkAllConfirmed()">
                            <span>ë‹¨ì–´ë¥¼ íƒ€ì¸ê³¼ ì ˆëŒ€ ê³µìœ í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤</span>
                        </label>
                    </div>
                </div>

                <!-- Step 6: ë‹¤ìš´ë¡œë“œ -->
                <div id="downloadSection" class="hidden">
                    <div class="step-title">
                        <span class="step-number">6</span>
                        ì§€ê°‘ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    </div>
                    <p style="margin-bottom: 15px; color: #64748b;">
                        ì•”í˜¸í™”ëœ ì§€ê°‘ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”. ì´ íŒŒì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ì§€ê°‘ì„ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <button class="download-btn" onclick="downloadKeystore()">
                        ğŸ’¾ Keystore íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="completeRegistration()" id="completeBtn" style="background: #10b981; margin-top: 15px;" disabled>
                        âœ… ë“±ë¡ ì™„ë£Œ
                    </button>
                </div>

                <!-- Success -->
                <div id="successSection" class="hidden success">
                    <h2>âœ… ë“±ë¡ ì™„ë£Œ!</h2>
                    <p style="margin-top: 15px; font-size: 16px;">
                        Public Key: <strong id="finalPublicKey"></strong>
                    </p>
                    <p style="margin-top: 10px;">
                        ê·€í•˜ì˜ ì§€ê°‘ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tokenData = null;
        let generatedMnemonic = null;
        let privateKey = null;
        let publicKey = null;
        let keystore = null;

        // URLì—ì„œ í† í° ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ê²€ì¦
        window.onload = async function() {
            if (!token) {
                showError('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. ì´ë©”ì¼ì˜ ë§í¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            await verifyToken(token);
        };

        // í† í° ê²€ì¦
        async function verifyToken(token) {
            try {
                const response = await fetch(`data/registration_tokens.json`);
                const data = await response.json();
                
                tokenData = data.tokens[token];
                
                if (!tokenData) {
                    showError('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.');
                    return;
                }

                if (tokenData.used) {
                    showError('ì´ë¯¸ ì‚¬ìš©ëœ í† í°ì…ë‹ˆë‹¤. ì´ë¯¸ ë“±ë¡ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.');
                    return;
                }

                const expiresAt = new Date(tokenData.expiresAt);
                if (new Date() > expiresAt) {
                    showError('ë§Œë£Œëœ í† í°ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // ì •ë³´ í‘œì‹œ
                document.getElementById('holderName').textContent = tokenData.name;
                document.getElementById('holderEmail').textContent = tokenData.email;
                document.getElementById('holderAllocation').textContent = `${tokenData.allocation.toLocaleString()} T`;

                // ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                showError('í† í° ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì§€ê°‘ ìƒì„±
        function generateWallet() {
            // BIP39 ë‹ˆëª¨ë‹‰ ìƒì„± (ê°„ë‹¨í•œ ë²„ì „ - ì‹¤ì œë¡œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
            const wordlist = [
                'ì‚¬ê³¼', 'ë°”ë‚˜ë‚˜', 'ì²´ë¦¬', 'ê°œ', 'ì½”ë¼ë¦¬', 'ë¬¼ê³ ê¸°', 'í¬ë„', 'ì§‘', 'ì–¼ìŒ', 'ì£¼ìŠ¤', 'ì™•', 'ì‚¬ì',
                'ì›ìˆ­ì´', 'ë°”ëŠ˜', 'ì˜¤ë Œì§€', 'ì¢…ì´', 'í€¸', 'í† ë¼', 'ë±€', 'í˜¸ë‘ì´', 'ìš°ì‚°', 'ê½ƒë³‘', 'ë¬¼', 'í¬ì„¸ë…¼',
                'ìš”íŠ¸', 'ì–¼ë£©ë§', 'ë‚˜ë¬´', 'ìƒˆ', 'ê³ ì–‘ì´', 'ìš©', 'ì½”ë¼ë¦¬', 'ì—¬ìš°', 'ê±°ìœ„', 'ëª¨ì', 'ì•„ì´ìŠ¤í¬ë¦¼', 'ì¼'
            ];

            generatedMnemonic = [];
            for (let i = 0; i < 12; i++) {
                generatedMnemonic.push(wordlist[Math.floor(Math.random() * wordlist.length)]);
            }

            // Private Key ìƒì„± (ë‹ˆëª¨ë‹‰ì—ì„œ ìœ ë„)
            privateKey = CryptoJS.SHA256(generatedMnemonic.join(' ')).toString();
            
            // Public Key ìƒì„± (ì‹¤ì œë¡œëŠ” ECDSA ì‚¬ìš©, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ)
            publicKey = '0x' + CryptoJS.SHA256(privateKey).toString().substring(0, 40);

            // Keystore ìƒì„± (AES ì•”í˜¸í™”)
            const password = prompt('ì§€ê°‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (8ì ì´ìƒ):');
            if (!password || password.length < 8) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const encryptedKey = CryptoJS.AES.encrypt(privateKey, password).toString();
            keystore = {
                version: 1,
                id: tokenData.holderId,
                address: publicKey,
                name: tokenData.name,
                allocation: tokenData.allocation,
                crypto: {
                    cipher: 'aes-256-ctr',
                    ciphertext: encryptedKey
                },
                timestamp: new Date().toISOString()
            };

            // ë‹ˆëª¨ë‹‰ í‘œì‹œ
            displayMnemonic();

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'âœ… ì§€ê°‘ ìƒì„± ì™„ë£Œ';
        }

        // ë‹ˆëª¨ë‹‰ í‘œì‹œ
        function displayMnemonic() {
            const container = document.getElementById('mnemonicWords');
            container.innerHTML = '';
            
            generatedMnemonic.forEach((word, index) => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'mnemonic-word';
                wordDiv.innerHTML = `
                    <span class="mnemonic-word-number">${index + 1}</span>
                    ${word}
                `;
                container.appendChild(wordDiv);
            });

            document.getElementById('mnemonicSection').classList.remove('hidden');
            document.getElementById('confirmSection').classList.remove('hidden');
        }

        // ëª¨ë“  í™•ì¸ì‚¬í•­ ì²´í¬ í™•ì¸
        function checkAllConfirmed() {
            const check1 = document.getElementById('check1').checked;
            const check2 = document.getElementById('check2').checked;
            const check3 = document.getElementById('check3').checked;

            if (check1 && check2 && check3) {
                document.getElementById('downloadSection').classList.remove('hidden');
            }
        }

        // Keystore ë‹¤ìš´ë¡œë“œ
        function downloadKeystore() {
            const blob = new Blob([JSON.stringify(keystore, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `egct-wallet-${tokenData.name}-${Date.now()}.json`;
            a.click();

            // ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('completeBtn').disabled = false;
            alert('ì§€ê°‘ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì„¸ìš”!');
        }

        // ë“±ë¡ ì™„ë£Œ
        async function completeRegistration() {
            if (!confirm('ë“±ë¡ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì™„ë£Œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            // ì‹¤ì œë¡œëŠ” ì„œë²„ì— Public Key ì „ì†¡
            // ì—¬ê¸°ì„œëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const registrationData = {
                token: token,
                name: tokenData.name,
                publicKey: publicKey,
                registeredAt: new Date().toISOString()
            };

            localStorage.setItem('egct_registration', JSON.stringify(registrationData));

            // ì„±ê³µ í‘œì‹œ
            document.getElementById('mainContent').innerHTML = '';
            document.getElementById('successSection').classList.remove('hidden');
            document.getElementById('finalPublicKey').textContent = publicKey;

            // í† í° ì‚¬ìš© ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ)
            console.log('Registration completed:', registrationData);
        }

        function showError(message) {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>

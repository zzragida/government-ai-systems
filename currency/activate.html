<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGCT Ledger ì´ˆê¸°í™” | ëŒ€í•œë¯¼êµ­ ì •ë¶€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            color: #212529;
        }
        .gov-header {
            background: #004C9E;
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gov-header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .gov-header h1 {
            font-size: 24px;
            font-weight: 700;
        }
        .gov-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        .main-content {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .card-title {
            color: #004C9E;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #004C9E;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 100px;
            transition: border-color 0.2s;
        }
        textarea:focus {
            outline: none;
            border-color: #004C9E;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #004C9E;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #004C9E;
            color: white;
            width: 100%;
        }
        .btn-primary:hover {
            background: #003d7a;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }
        .step:last-child::after {
            display: none;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .step.active .step-number {
            background: #004C9E;
            color: white;
        }
        .step-label {
            font-size: 12px;
            color: #6c757d;
        }
        .step.active .step-label {
            color: #004C9E;
            font-weight: 600;
        }
        .hidden {
            display: none !important;
        }
        .holder-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .holder-info p {
            margin: 8px 0;
            font-size: 14px;
        }
        .holder-info strong {
            color: #004C9E;
        }
    </style>
</head>
<body>
    <div class="gov-header">
        <div class="container">
            <h1>ğŸ›ï¸ EGCT Ledger ì´ˆê¸°í™”</h1>
            <div class="subtitle">ëŒ€í•œë¯¼êµ­ ì •ë¶€ ë””ì§€í„¸ í™”í ì‹œìŠ¤í…œ</div>
        </div>
    </div>

    <div class="main-content">
        <div class="step-indicator">
            <div class="step active" id="step-ind-1">
                <div class="step-number">1</div>
                <div class="step-label">ì„ì‹œ í‚¤ ì…ë ¥</div>
            </div>
            <div class="step" id="step-ind-2">
                <div class="step-number">2</div>
                <div class="step-label">ë³¸ì¸ í™•ì¸</div>
            </div>
            <div class="step" id="step-ind-3">
                <div class="step-number">3</div>
                <div class="step-label">ì§€ê°‘ ìƒì„±</div>
            </div>
        </div>

        <!-- Step 1: ì„ì‹œ Public Key ì…ë ¥ -->
        <div class="card" id="step1">
            <div class="card-title">1ë‹¨ê³„: ì„ì‹œ Public Key ì…ë ¥</div>
            
            <div class="info-box">
                <strong>ğŸ“§ ì´ë©”ì¼ì—ì„œ ë°›ì€ ì •ë³´:</strong><br>
                â€¢ ìµëª…í™”ëœ ëª…ë‹¨ì—ì„œ ìì‹ ì˜ ì´ë¦„ê³¼ ì´ë©”ì¼ í™•ì¸<br>
                â€¢ í•´ë‹¹í•˜ëŠ” ì„ì‹œ Public Key (66ìë¦¬) ë³µì‚¬<br>
                â€¢ í˜•ì‹: 0xë¡œ ì‹œì‘í•˜ëŠ” 16ì§„ìˆ˜
            </div>

            <div class="form-group">
                <label for="tempKeyInput">ì„ì‹œ Public Key (66ìë¦¬)</label>
                <textarea id="tempKeyInput" placeholder="0x..."></textarea>
            </div>

            <button class="btn btn-primary" onclick="verifyTempKey()">í™•ì¸ ë° ë‹¤ìŒ ë‹¨ê³„</button>
            <button class="btn btn-secondary" onclick="location.href='index.html'">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- Step 2: ë³¸ì¸ í™•ì¸ -->
        <div class="card hidden" id="step2">
            <div class="card-title">2ë‹¨ê³„: ë³¸ì¸ í™•ì¸</div>
            
            <div class="holder-info" id="holderInfo"></div>

            <div class="info-box">
                <strong>âš ï¸ ë³´ì•ˆ í™•ì¸:</strong><br>
                ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”
            </div>

            <div class="form-group">
                <label for="cityInput">ê±°ì£¼ ì§€ì—­ (ì‹œ ë‹¨ìœ„)</label>
                <input type="text" id="cityInput" placeholder="ì˜ˆ: ì„±ë‚¨ì‹œ, ì„œìš¸ì‹œ, ì œì£¼ì‹œ">
            </div>

            <div class="form-group">
                <label for="phonePrefixInput">ì „í™”ë²ˆí˜¸ ì• 4ìë¦¬</label>
                <input type="text" id="phonePrefixInput" placeholder="ì˜ˆ: 9529" maxlength="4">
            </div>

            <button class="btn btn-primary" onclick="verifyIdentity()">ë³¸ì¸ í™•ì¸</button>
            <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „ ë‹¨ê³„</button>
        </div>

        <!-- Step 3: ì§€ê°‘ ìƒì„± -->
        <div class="card hidden" id="step3">
            <div class="card-title">3ë‹¨ê³„: ì§€ê°‘ ìƒì„±</div>
            
            <div class="info-box">
                <strong>ğŸ” ì¤‘ìš”:</strong><br>
                ìƒì„±ë˜ëŠ” 12ê°œì˜ ë³µêµ¬ ë‹¨ì–´ë¥¼ ë°˜ë“œì‹œ ì¢…ì´ì— ê¸°ë¡í•˜ê³  ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”.<br>
                ë³µêµ¬ ë‹¨ì–´ë¥¼ ë¶„ì‹¤í•˜ë©´ ìì‚°ì„ ì˜êµ¬ì ìœ¼ë¡œ ìƒê²Œ ë©ë‹ˆë‹¤.
            </div>

            <button class="btn btn-primary" onclick="generateWallet()">ì§€ê°‘ ìƒì„±</button>

            <div id="walletResult" class="hidden" style="margin-top: 20px;">
                <div class="form-group" style="position: relative;">
                    <label>ë³µêµ¬ ë‹¨ì–´ (12ê°œ, ì¢…ì´ì— ê¸°ë¡)
                        <button onclick="copyToClipboard('mnemonicDisplay')" style="
                            float: right;
                            padding: 4px 10px;
                            background: #004C9E;
                            color: white;
                            border: none;
                            border-radius: 3px;
                            cursor: pointer;
                            font-size: 12px;
                        ">ğŸ“‹ ë³µì‚¬</button>
                    </label>
                    <textarea id="mnemonicDisplay" readonly style="background: #f8f9fa;"></textarea>
                </div>

                <div class="form-group" style="position: relative;">
                    <label>ìƒˆ Public Key
                        <button onclick="copyToClipboard('newPublicKeyDisplay')" style="
                            float: right;
                            padding: 4px 10px;
                            background: #004C9E;
                            color: white;
                            border: none;
                            border-radius: 3px;
                            cursor: pointer;
                            font-size: 12px;
                        ">ğŸ“‹ ë³µì‚¬</button>
                    </label>
                    <input type="text" id="newPublicKeyDisplay" readonly style="background: #f8f9fa; font-family: 'Courier New', monospace;">
                </div>

                <button class="btn btn-primary" onclick="confirmActivation()">í™•ì¸ ë° Ledger í™œì„±í™”</button>
            </div>
        </div>

        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>
    </div>

    <script>
        let currentHolder = null;

        function goToStep(stepNum) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('step' + stepNum).classList.remove('hidden');
            
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-ind-' + stepNum).classList.add('active');
        }

        async function verifyTempKey() {
            const tempKey = document.getElementById('tempKeyInput').value.trim();
            
            if (!tempKey || !tempKey.startsWith('0x') || tempKey.length !== 66) {
                showError('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ì„ì‹œ Public Keyë¥¼ ì…ë ¥í•˜ì„¸ìš” (66ìë¦¬, 0xë¡œ ì‹œì‘)');
                return;
            }

            try {
                const response = await fetch('data/holders.json');
                const data = await response.json();
                
                const holder = data.holders.find(h => h.tempPublicKey === tempKey);
                
                if (!holder) {
                    showError('ì¼ì¹˜í•˜ëŠ” ë³´ìœ ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„ì‹œ Public Keyë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.');
                    return;
                }

                if (holder.status === 'activated') {
                    showError('ì´ë¯¸ í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.');
                    return;
                }

                currentHolder = holder;
                
                document.getElementById('holderInfo').innerHTML = `
                    <p><strong>ì´ë¦„:</strong> ${holder.name.substring(0, 1)}***</p>
                    <p><strong>EGCT í• ë‹¹ëŸ‰:</strong> ${holder.balance.toLocaleString()} T</p>
                    <p><strong>ìƒíƒœ:</strong> ëŒ€ê¸° ì¤‘</p>
                `;
                
                goToStep(2);
                
            } catch (error) {
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function verifyIdentity() {
            const city = document.getElementById('cityInput').value.trim();
            const phonePrefix = document.getElementById('phonePrefixInput').value.trim();

            if (!city || !phonePrefix) {
                showError('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (phonePrefix.length !== 4 || !/^\d{4}$/.test(phonePrefix)) {
                showError('ì „í™”ë²ˆí˜¸ ì• 4ìë¦¬ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° í†µê³¼
            if (!currentHolder.city && !currentHolder.phonePrefix) {
                goToStep(3);
                return;
            }

            // ì •ë³´ í™•ì¸
            if (currentHolder.city && city !== currentHolder.city) {
                showError('ê±°ì£¼ ì§€ì—­ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (currentHolder.phonePrefix && phonePrefix !== currentHolder.phonePrefix) {
                showError('ì „í™”ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            goToStep(3);
        }

        function generateWallet() {
            const koreanWords = [
                'ê°€ê²©', 'ê°€ëŠ¥', 'ê°€ì¡±', 'ê°„ê²©', 'ê°ê°', 'ê°•ë„', 'ê°œë…', 'ê±°ë¦¬', 'ê±´ë¬¼', 'ê²°ê³¼',
                'ê²½ìš°', 'ê³„íš', 'ê³ ê°', 'ê³µê°„', 'ê³¼ì •', 'ê´€ê³„', 'êµìœ¡', 'êµ¬ì¡°', 'êµ­ê°€', 'ê¶Œë¦¬',
                'ê¸°ê°„', 'ê¸°ìˆ ', 'ê¸°ì—…', 'ê¸°íšŒ', 'ëŠ¥ë ¥', 'ë‹¨ê³„', 'ëŒ€ìƒ', 'ë„ì‹œ', 'ë™ì•ˆ', 'ë°©ë²•',
                'ë²”ìœ„', 'ë³€í™”', 'ë³´í˜¸', 'ë¶„ì•¼', 'ì‚¬ëŒ', 'ì‚¬íšŒ', 'ìƒí™©', 'ìƒê°', 'ì„±ê³¼', 'ì„¸ê³„'
            ];
            
            let mnemonic = '';
            for (let i = 0; i < 12; i++) {
                const randomIndex = Math.floor(Math.random() * koreanWords.length);
                mnemonic += koreanWords[randomIndex] + (i < 11 ? ' ' : '');
            }
            
            const newPublicKey = '0x' + Array.from({length: 64}, () => 
                Math.floor(Math.random() * 16).toString(16)
            ).join('');
            
            document.getElementById('mnemonicDisplay').value = mnemonic;
            document.getElementById('newPublicKeyDisplay').value = newPublicKey;
            document.getElementById('walletResult').classList.remove('hidden');
        }


        // í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.value;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    fallbackCopy(element);
                });
            } else {
                fallbackCopy(element);
            }
        }
        
        // êµ¬í˜• ë¸Œë¼ìš°ì €ìš© ë³µì‚¬
        function fallbackCopy(element) {
            element.select();
            element.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                alert('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                alert('âŒ ë³µì‚¬ ì‹¤íŒ¨: ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ì„¸ìš”.');
            }
        }

        function confirmActivation() {
            const confirmed = confirm(
                'ë³µêµ¬ ë‹¨ì–´ë¥¼ ì•ˆì „í•˜ê²Œ ê¸°ë¡í•˜ì…¨ìŠµë‹ˆê¹Œ?\n\n' +
                'âš ï¸ ì´ ë‹¨ì–´ë“¤ì„ ìƒì–´ë²„ë¦¬ë©´ ìì‚°ì„ ì˜êµ¬ì ìœ¼ë¡œ ìƒê²Œ ë©ë‹ˆë‹¤!\n\n' +
                'ì¢…ì´ì— ê¸°ë¡í•˜ê³  ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ì…¨ë‹¤ë©´ "í™•ì¸"ì„ ëˆ„ë¥´ì„¸ìš”.'
            );
            
            if (!confirmed) return;

            const newPublicKey = document.getElementById('newPublicKeyDisplay').value;
            const mnemonic = document.getElementById('mnemonicDisplay').value;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
            localStorage.setItem('egct_logged_in', 'true');
            localStorage.setItem('egct_public_key', newPublicKey);
            localStorage.setItem('egct_holder_name', currentHolder.name);
            localStorage.setItem('egct_balance', currentHolder.balance);
            
            showSuccess(
                'âœ… Ledger ì´ˆê¸°í™” ì™„ë£Œ!<br><br>' +
                '<strong>í• ë‹¹ëŸ‰:</strong> ' + currentHolder.balance.toLocaleString() + ' T<br>' +
                '<strong>Public Key:</strong> ' + newPublicKey.substring(0, 20) + '...<br><br>' +
                '3ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...'
            );
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.innerHTML = 'âŒ ' + message;
            alert.style.display = 'block';
            document.getElementById('successAlert').style.display = 'none';
            setTimeout(() => { alert.style.display = 'none'; }, 5000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.innerHTML = message;
            alert.style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';
        }

        // URLì—ì„œ tempKey íŒŒë¼ë¯¸í„° í™•ì¸ ë° ìë™ ê²€ì¦
        const urlParams = new URLSearchParams(window.location.search);
        const tempKeyParam = urlParams.get('tempKey');
        if (tempKeyParam) {
            // Step 1 ìˆ¨ê¸°ê¸°
            document.getElementById('step1').style.display = 'none';
            // ìë™ ê²€ì¦ ì‹¤í–‰
            autoVerifyTempKey(tempKeyParam);
        }
        
        // ìë™ ê²€ì¦ í•¨ìˆ˜
        async function autoVerifyTempKey(tempKey) {
            try {
                const response = await fetch('data/holders.json');
                const data = await response.json();
                
                const holder = data.holders.find(h => h.tempPublicKey === tempKey);
                
                if (!holder) {
                    showError('ì¼ì¹˜í•˜ëŠ” ë³´ìœ ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('step1').style.display = 'block';
                    return;
                }

                if (holder.status === 'activated') {
                    showError('ì´ë¯¸ í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.');
                    document.getElementById('step1').style.display = 'block';
                    return;
                }

                currentHolder = holder;
                
                document.getElementById('holderInfo').innerHTML = `
                    <p><strong>ì´ë¦„:</strong> ${holder.name.substring(0, 1)}***</p>
                    <p><strong>EGCT í• ë‹¹ëŸ‰:</strong> ${holder.balance.toLocaleString()} T</p>
                    <p><strong>ìƒíƒœ:</strong> ëŒ€ê¸° ì¤‘</p>
                `;
                
                // ë°”ë¡œ Step 2ë¡œ ì´ë™
                goToStep(2);
                
            } catch (error) {
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('step1').style.display = 'block';
            }
        }
    </script>
</body>
</html>

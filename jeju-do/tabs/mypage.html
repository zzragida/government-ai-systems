<style>
    .mypage-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .pdv-info-section {
        background: linear-gradient(135deg, #003d82 0%, #0052a8 100%);
        color: white;
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 40px;
        box-shadow: 0 4px 12px rgba(0,61,130,0.2);
    }

    .pdv-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .pdv-info-title {
        font-size: 1.5em;
        font-weight: 700;
    }

    .pdv-info-badge {
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
    }

    .pdv-info-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .pdv-info-item {
        background: rgba(255,255,255,0.1);
        padding: 16px;
        border-radius: 4px;
    }

    .pdv-info-label {
        font-size: 0.85em;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .pdv-info-value {
        font-size: 1.1em;
        font-weight: 600;
    }

    .documents-section {
        background: white;
        border: 1px solid #d5d5d5;
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 40px;
    }

    .documents-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e0e0e0;
    }

    .documents-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #1a1a1a;
    }

    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .document-card {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .document-card:hover {
        background: white;
        border-color: #003d82;
        box-shadow: 0 2px 8px rgba(0,61,130,0.1);
    }

    .document-icon {
        font-size: 2em;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 4px;
    }

    .document-info {
        flex: 1;
    }

    .document-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .document-status {
        font-size: 0.85em;
        color: #666;
    }

    .document-status.available {
        color: #2e7d32;
    }

    .document-status.missing {
        color: #d32f2f;
    }

    .activities-section {
        background: white;
        border: 1px solid #d5d5d5;
        border-radius: 8px;
        padding: 32px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #1a1a1a;
    }

    .search-box {
        padding: 8px 16px;
        border: 1px solid #d5d5d5;
        border-radius: 4px;
        width: 300px;
    }

    .timeline {
        position: relative;
        padding-left: 40px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e0e0e0;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 32px;
        background: #f9f9f9;
        border-radius: 6px;
        padding: 20px;
        border-left: 3px solid #003d82;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -27px;
        top: 24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #003d82;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #e0e0e0;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .timeline-type {
        display: inline-block;
        padding: 4px 12px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .timeline-date {
        font-size: 0.9em;
        color: #666;
    }

    .timeline-content {
        color: #333;
        margin-bottom: 8px;
    }

    .timeline-metadata {
        font-size: 0.85em;
        color: #666;
    }

    .btn-create-hash {
        background: #2e7d32;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        margin-top: 24px;
    }

    .btn-create-hash:hover {
        background: #1b5e20;
        box-shadow: 0 4px 12px rgba(46,125,50,0.3);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 16px;
    }
</style>

<div class="mypage-container">
    <!-- PDV ì •ë³´ ì„¹ì…˜ -->
    <div id="pdv-info-section" class="pdv-info-section"></div>

    <!-- í•„ìš” ì„œë¥˜ ì„¹ì…˜ -->
    <div id="documents-section" class="documents-section"></div>

    <!-- í™œë™ íƒ€ì„ë¼ì¸ ì„¹ì…˜ -->
    <div class="activities-section">
        <div class="section-header">
            <h2 class="section-title">ğŸ“‹ PDV í™œë™ íƒ€ì„ë¼ì¸</h2>
            <input type="text" id="activity-search" class="search-box" placeholder="í™œë™ ê²€ìƒ‰...">
        </div>
        
        <div id="timeline-container" class="timeline"></div>
        
        <div id="create-hash-btn-container"></div>
    </div>
</div>

<script>
// My Page ì´ˆê¸°í™”
function initMyPage() {
    const user = window.authManager?.getCurrentUser();
    
    if (!user) {
        showEmptyMyPage();
        return;
    }
    
    displayPDVInfo(user);
    displayDocuments(user);
    loadActivities(user);
}

// PDV ì •ë³´ í‘œì‹œ
function displayPDVInfo(user) {
    const container = document.getElementById('pdv-info-section');
    
    let typeInfo = '';
    let detailsHTML = '';
    
    if (user.type === 'citizen') {
        typeInfo = 'ğŸ™‹ ê°œì¸';
        detailsHTML = `
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì´ë¦„</div>
                <div class="pdv-info-value">${user.personData?.name || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì£¼ì†Œ</div>
                <div class="pdv-info-value">${user.personData?.address || '-'}</div>
            </div>
        `;
    } else {
        typeInfo = 'ğŸ¢ ë‹¨ì²´';
        detailsHTML = `
            <div class="pdv-info-item">
                <div class="pdv-info-label">ë‹¨ì²´ëª…</div>
                <div class="pdv-info-value">${user.orgData?.name || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ë‹¨ì²´ ì¢…ë¥˜</div>
                <div class="pdv-info-value">${user.orgData?.orgType || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì£¼ì†Œ</div>
                <div class="pdv-info-value">${user.orgData?.address || '-'}</div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="pdv-info-header">
            <div class="pdv-info-title">Private Data Vault</div>
            <div class="pdv-info-badge">${typeInfo}</div>
        </div>
        <div class="pdv-info-item">
            <div class="pdv-info-label">PDV ID</div>
            <div class="pdv-info-value">${user.pdvId}</div>
        </div>
        <div class="pdv-info-item">
            <div class="pdv-info-label">ì „í™”ë²ˆí˜¸</div>
            <div class="pdv-info-value">${user.phoneNumber}</div>
        </div>
        <div class="pdv-info-details">
            ${detailsHTML}
            <div class="pdv-info-item">
                <div class="pdv-info-label">ìƒì„±ì¼</div>
                <div class="pdv-info-value">${new Date(user.createdAt).toLocaleDateString('ko-KR')}</div>
            </div>
        </div>
    `;
}

// í•„ìš” ì„œë¥˜ í‘œì‹œ
function displayDocuments(user) {
    const container = document.getElementById('documents-section');
    
    let documents = [];
    let title = '';
    
    if (user.type === 'citizen') {
        documents = window.CITIZEN_DOCUMENTS || [];
        title = 'ê°œì¸ í•„ìš” ì„œë¥˜';
    } else {
        const orgType = user.orgData?.orgType;
        if (orgType && window.ORGANIZATION_TYPES && window.ORGANIZATION_TYPES[orgType]) {
            documents = window.ORGANIZATION_TYPES[orgType].documents || [];
            title = `${orgType} í•„ìš” ì„œë¥˜`;
        }
    }
    
    if (documents.length === 0) {
        container.innerHTML = `
            <div class="documents-header">
                <h2 class="documents-title">ğŸ“„ í•„ìš” ì„œë¥˜</h2>
            </div>
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <p>í•„ìš” ì„œë¥˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    const userDocuments = user.documents || [];
    
    let documentsHTML = documents.map(docName => {
        const hasDocument = userDocuments.some(doc => doc.name === docName);
        const statusClass = hasDocument ? 'available' : 'missing';
        const statusText = hasDocument ? 'ë³´ìœ ' : 'ë¯¸ë³´ìœ ';
        const icon = hasDocument ? 'âœ…' : 'ğŸ“„';
        
        return `
            <div class="document-card" onclick="handleDocumentClick('${docName}')">
                <div class="document-icon">${icon}</div>
                <div class="document-info">
                    <div class="document-name">${docName}</div>
                    <div class="document-status ${statusClass}">${statusText}</div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="documents-header">
            <h2 class="documents-title">ğŸ“„ ${title}</h2>
            <small style="color: #666;">ì´ ${documents.length}ê°œ ì„œë¥˜ (ë³´ìœ : ${userDocuments.length}ê°œ)</small>
        </div>
        <p style="color: #666; margin-bottom: 20px;">
            âš ï¸ ì´ ì„œë¥˜ë“¤ì€ ë³¸ì¸ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íƒ€ì¸ì—ê²Œ ê³µìœ í•˜ê±°ë‚˜ ì „ì†¡í•˜ë ¤ë©´ ë³„ë„ì˜ ê¶Œí•œ ë¶€ì—¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
        <div class="documents-grid">
            ${documentsHTML}
        </div>
    `;
}

// ì„œë¥˜ í´ë¦­ í•¸ë“¤ëŸ¬
function handleDocumentClick(docName) {
    alert(`"${docName}" ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\ní–¥í›„ ì—…ë¡œë“œ, ë‹¤ìš´ë¡œë“œ, ê³µìœ  ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.`);
}

// í™œë™ ë¡œë“œ
function loadActivities(user) {
    const activities = user.activities || [];
    const container = document.getElementById('timeline-container');
    
    if (activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p style="font-size: 1.1em; margin-bottom: 8px;">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p style="color: #999;">AI ìƒë‹´, ë¬¸ì„œ ì „ì†¡ ë“±ì˜ í™œë™ì´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤</p>
            </div>
        `;
        document.getElementById('create-hash-btn-container').innerHTML = '';
        return;
    }
    
    // ì¼ë ¨ë²ˆí˜¸ ë¶€ì—¬ (ì‹œê°„ìˆœ ì •ë ¬)
    const sortedActivities = activities.sort((a, b) => 
        new Date(a.timestamp) - new Date(b.timestamp)
    );
    
    sortedActivities.forEach((activity, index) => {
        activity.serialNumber = index + 1;
    });
    
    // íƒ€ì„ë¼ì¸ ë Œë”ë§
    let html = sortedActivities.map(activity => `
        <div class="timeline-item">
            <div class="timeline-header">
                <span class="timeline-type">#${activity.serialNumber} - ${activity.type}</span>
                <span class="timeline-date">${new Date(activity.timestamp).toLocaleString('ko-KR')}</span>
            </div>
            <div class="timeline-content">${activity.content}</div>
            ${activity.counterparty ? `<div class="timeline-metadata">ìƒëŒ€ë°©: ${activity.counterparty}</div>` : ''}
            ${activity.location ? `<div class="timeline-metadata">ì¥ì†Œ: ${activity.location}</div>` : ''}
        </div>
    `).join('');
    
    container.innerHTML = html;
    
    // OpenHash ìƒì„± ë²„íŠ¼
    if (activities.length >= 5) {
        document.getElementById('create-hash-btn-container').innerHTML = `
            <button class="btn-create-hash" onclick="createOpenHashGroups()">
                ğŸ”— OpenHash ìƒì„± (${activities.length}ê°œ í™œë™)
            </button>
        `;
    }
}

// OpenHash ìƒì„±
async function createOpenHashGroups() {
    const user = window.authManager?.getCurrentUser();
    if (!user || !user.activities) return;
    
    const activities = user.activities;
    
    if (activities.length < 5) {
        alert('OpenHashë¥¼ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 5ê°œì˜ í™œë™ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        const groups = await window.openHashManager.createHashGroups(activities);
        
        // ê° ê·¸ë£¹ ì €ì¥
        groups.forEach(group => {
            window.openHashManager.saveHashRecord(group, user.pdvId);
        });
        
        alert(`âœ… ${groups.length}ê°œì˜ OpenHash ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
        // OpenHash íƒ­ìœ¼ë¡œ ì´ë™ ì œì•ˆ
        if (confirm('OpenHash íƒ­ì—ì„œ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if (typeof switchTab === 'function') {
                switchTab('openhash');
            }
        }
        
        // ë²„íŠ¼ ì—…ë°ì´íŠ¸
        document.getElementById('create-hash-btn-container').innerHTML = `
            <button class="btn-create-hash" disabled style="opacity: 0.5; cursor: not-allowed;">
                âœ“ OpenHash ìƒì„±ë¨
            </button>
        `;
    } catch (error) {
        console.error('OpenHash ìƒì„± ì˜¤ë¥˜:', error);
        alert('OpenHash ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë¹ˆ My Page í‘œì‹œ
function showEmptyMyPage() {
    document.querySelector('.mypage-container').innerHTML = `
        <div class="empty-state" style="padding: 100px 20px;">
            <div class="empty-state-icon">ğŸ”</div>
            <h2 style="margin-bottom: 12px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p style="color: #666; margin-bottom: 24px;">Private Data Vaultì— ì ‘ê·¼í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <button onclick="openLoginModal()" style="padding: 12px 32px; background: #003d82; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1em;">
                ë¡œê·¸ì¸í•˜ê¸°
            </button>
        </div>
    `;
}

// ê²€ìƒ‰ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('activity-search');
    if (searchBox) {
        searchBox.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const items = document.querySelectorAll('.timeline-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
});

// ì „ì—­ í•¨ìˆ˜ ë“±ë¡
if (typeof window.initMyPage === 'undefined') {
    window.initMyPage = initMyPage;
}
</script>
